<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <meta name="description" content="Free sleep cycle calculator with adjustable sleep latency, 90-minute cycles, and a wake window. Find the best time to go to bed or wake up feeling refreshed." />
  
  <meta property="og:title" content="NightOwl Sleep Cycle Calculator" />
  <meta property="og:description" content="Calculate the perfect bedtime and wake time based on sleep cycles. Plan your sleep for better rest and easier mornings." />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://replit.com/public/images/opengraph.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="@replit" />
  <meta name="twitter:title" content="NightOwl Sleep Cycle Calculator" />
  <meta name="twitter:description" content="Calculate the perfect bedtime and wake time based on sleep cycles. Plan your sleep for better rest and easier mornings." />
  <meta name="twitter:image" content="https://replit.com/public/images/opengraph.png" />

  <link rel="icon" type="image/png" href="/favicon.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Poppins:ital,wght@0,500;0,600;0,700;1,500;1,600;1,700&display=swap" rel="stylesheet">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'DM Sans', system-ui, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #e2e8f0;
      line-height: 1.6;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 40px;
      padding-top: 20px;
    }

    .brand {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 16px;
    }

    .logo {
      font-size: 24px;
    }

    .brand-name {
      font-size: 22px;
      font-weight: 600;
      color: #cbd5e1;
    }

    .title {
      font-family: 'Poppins', sans-serif;
      font-size: 25px;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 8px;
      letter-spacing: -0.5px;
    }

    .subtitle {
      font-size: 13px;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .ad-space {
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid rgba(99, 102, 241, 0.2);
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      color: #64748b;
      margin-bottom: 30px;
      font-size: 13px;
    }

    .mode-tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 32px;
      background: rgba(30, 41, 59, 0.6);
      padding: 8px;
      border-radius: 12px;
      border: 1px solid rgba(99, 102, 241, 0.2);
    }

    .mode-btn {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      background: transparent;
      color: #94a3b8;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .mode-btn.active {
      background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
    }

    .mode-btn:hover:not(.active) {
      color: #cbd5e1;
      background: rgba(99, 102, 241, 0.1);
    }

    .main-content {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.8) 100%);
      border: 1px solid rgba(99, 102, 241, 0.3);
      border-radius: 16px;
      padding: 32px;
      backdrop-filter: blur(10px);
    }

    .label {
      display: block;
      font-family: 'Poppins', sans-serif;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #f1f5f9;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 32px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .settings-grid.show {
      max-height: 500px;
    }

    .setting-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .setting-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #94a3b8;
      font-weight: 500;
    }

    .setting-value {
      font-size: 20px;
      font-weight: 600;
      color: #4f46e5;
    }

    input[type="range"] {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: rgba(99, 102, 241, 0.2);
      outline: none;
      accent-color: #4f46e5;
      cursor: pointer;
    }

    .time-format-toggle {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .toggle-switch {
      display: flex;
      background: rgba(99, 102, 241, 0.2);
      border-radius: 20px;
      padding: 4px;
      width: 110px;
      cursor: pointer;
      border: 1px solid rgba(99, 102, 241, 0.3);
      transition: all 0.3s ease;
    }

    .toggle-switch.active {
      background: rgba(99, 102, 241, 0.4);
      border-color: rgba(99, 102, 241, 0.6);
    }

    .toggle-option {
      flex: 1;
      padding: 6px 12px;
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      color: #94a3b8;
      border-radius: 16px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .toggle-option.active {
      background: #4f46e5;
      color: white;
    }

    .time-picker-container {
      position: relative;
      margin-bottom: 32px;
    }

    .time-picker-wrapper {
      position: relative;
      overflow: hidden;
    }

    .time-picker {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, rgba(51, 65, 85, 0.8) 0%, rgba(30, 41, 59, 0.8) 100%);
      border: 1px solid rgba(99, 102, 241, 0.4);
      border-radius: 14px;
      padding: 24px;
      touch-action: none;
      position: relative;
      min-height: 180px;
    }

    .time-column {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      position: relative;
      flex: 0 0 auto;
      height: 180px;
      overflow: hidden;
      cursor: ns-resize;
    }

    .time-column-faded {
      font-size: 18px;
      color: rgba(148, 163, 184, 0.3);
      font-weight: 500;
      min-height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .time-column-selected {
      font-size: 56px;
      font-weight: 700;
      color: #e0e7ff;
      text-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
      font-family: 'Poppins', monospace;
      letter-spacing: 0.5px;
      min-height: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .time-column-separator {
      font-size: 48px;
      font-weight: 700;
      color: #fbbf24;
      margin: 0 4px;
    }

    .time-column-highlight {
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 64px;
      transform: translateY(-50%);
      border-top: 1px solid rgba(99, 102, 241, 0.5);
      border-bottom: 1px solid rgba(99, 102, 241, 0.5);
      pointer-events: none;
    }

    .owl-perch {
      position: absolute;
      top: -100px;
      right: 16px;
      font-size: 120px;
      z-index: 10;
      line-height: 1;
      transform: scaleX(-1);
    }

    .results {
      margin-top: 32px;
    }

    .results-label {
      font-family: 'Poppins', sans-serif;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #f1f5f9;
    }

    .results-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .result-card {
      background: rgba(30, 41, 59, 0.6);
      border: 2px solid rgba(148, 163, 184, 0.2);
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: left;
    }

    .result-card:hover {
      border-color: rgba(99, 102, 241, 0.6);
      background: rgba(51, 65, 85, 0.8);
    }

    .result-card.selected {
      background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
      border-color: #4f46e5;
      box-shadow: 0 8px 24px rgba(79, 70, 229, 0.4);
    }

    .result-card.best::before {
      content: '‚òÖ Best Option';
      display: block;
      font-size: 11px;
      color: #fbbf24;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .result-time {
      font-size: 28px;
      font-weight: 700;
      font-family: 'Poppins', monospace;
      margin-bottom: 6px;
    }

    .result-card.selected .result-time {
      color: white;
    }

    .result-card:not(.selected) .result-time {
      color: #a5b4fc;
    }

    .result-window {
      font-size: 15px;
      color: #a5b4fc;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .result-details {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 14px;
    }

    .result-detail {
      color: #94a3b8;
    }

    .result-card.selected .result-detail {
      color: rgba(255, 255, 255, 0.8);
    }

    .settings-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      padding-top: 24px;
      border-top: 1px solid rgba(99, 102, 241, 0.2);
    }

    .settings-toggle-btn {
      background: none;
      border: none;
      color: #94a3b8;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      padding: 0;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: color 0.3s ease;
    }

    .settings-toggle-btn:hover {
      color: #cbd5e1;
    }

    .settings-toggle-btn::after {
      content: '‚öôÔ∏è';
      font-size: 18px;
    }

    .share-btn {
      background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 16px;
      display: inline-block;
    }

    .share-btn:hover {
      box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
      transform: translateY(-2px);
    }

    .share-btn:active {
      transform: translateY(0);
    }

    .info-toggle {
      width: 100%;
      background: transparent;
      border: 1px solid rgba(99, 102, 241, 0.3);
      border-radius: 0;
      padding: 16px;
      margin: 0;
      font-size: 15px;
      font-weight: 500;
      color: #cbd5e1;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }

    .info-toggle:first-of-type {
      margin-top: 32px;
      border-radius: 8px 8px 0 0;
    }

    .info-toggle:hover {
      border-color: rgba(99, 102, 241, 0.6);
      background: rgba(99, 102, 241, 0.05);
    }

    .info-toggle .info-arrow {
      transition: transform 0.3s ease;
      display: inline-block;
      font-size: 12px;
    }

    .info-toggle.expanded .info-arrow {
      transform: rotate(180deg);
    }

    .info-section {
      background: rgba(99, 102, 241, 0.1);
      border: 1px solid rgba(99, 102, 241, 0.2);
      border-top: none;
      border-radius: 0;
      padding: 16px;
      margin: 0;
      font-size: 14px;
      line-height: 1.7;
      color: #cbd5e1;
    }

    .info-section:last-of-type {
      border-radius: 0 0 8px 8px;
      margin-bottom: 24px;
    }

    .info-section p {
      margin-bottom: 14px;
    }

    .info-section p:last-child {
      margin-bottom: 0;
    }

    footer {
      text-align: center;
      margin-top: 60px;
      padding: 24px 20px;
      color: #64748b;
      font-size: 12px;
      line-height: 1.8;
      border-top: 1px solid rgba(99, 102, 241, 0.15);
    }

    footer .footer-copyright {
      margin-bottom: 8px;
    }

    footer .footer-disclaimer {
      font-size: 11px;
      color: #475569;
    }

    @media (max-width: 480px) {
      .title {
        font-size: 28px;
      }

      .main-content {
        padding: 20px;
      }

      .settings-grid {
        grid-template-columns: 1fr;
      }

      .time-picker {
        padding: 20px 16px;
      }

      .time-column-selected {
        font-size: 48px;
      }

      .result-card {
        padding: 12px;
      }

      .result-time {
        font-size: 24px;
      }
    }
  </style>

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@graph": [
      {
        "@type": "WebSite",
        "@id": "#website",
        "url": "https://nightowlsleepcalc.com/",
        "name": "NightOwl Sleep Calc",
        "description": "Sleep cycle calculator with adjustable sleep latency and a wake window to help you find better bedtimes and wake-up times.",
        "inLanguage": "en"
      },
      {
        "@type": "WebApplication",
        "@id": "#app",
        "name": "NightOwl Sleep Cycle Calculator",
        "url": "https://nightowlsleepcalc.com/",
        "applicationCategory": "HealthApplication",
        "operatingSystem": "Any",
        "isAccessibleForFree": true,
        "browserRequirements": "Requires JavaScript",
        "description": "A free sleep cycle calculator that suggests bedtimes or wake-up times using 90-minute sleep cycles, adjustable sleep latency, and an optional wake window.",
        "offers": {
          "@type": "Offer",
          "price": "0",
          "priceCurrency": "USD"
        },
        "publisher": {
          "@type": "Organization",
          "name": "NightOwl Sleep Calc",
          "url": "https://nightowlsleepcalc.com/"
        }
      },
      {
        "@type": "FAQPage",
        "@id": "#faq",
        "mainEntity": [
          {
            "@type": "Question",
            "name": "How many sleep cycles do I need?",
            "acceptedAnswer": {
              "@type": "Answer",
              "text": "Most adults feel best with about 5‚Äì6 full sleep cycles, which is roughly 7.5‚Äì9 hours of sleep time (plus the time it takes to fall asleep). Your ideal number can vary based on your schedule, recent sleep debt, and how you feel in the morning."
            }
          },
          {
            "@type": "Question",
            "name": "Why does the calculator use 90-minute cycles?",
            "acceptedAnswer": {
              "@type": "Answer",
              "text": "A full sleep cycle (light sleep ‚Üí deeper sleep ‚Üí REM) often averages around 90 minutes, but it can be shorter or longer depending on the person and the night. This calculator lets you adjust cycle length so you can match what works best for you."
            }
          },
          {
            "@type": "Question",
            "name": "What's a normal sleep latency?",
            "acceptedAnswer": {
              "@type": "Answer",
              "text": "Sleep latency is how long it takes you to fall asleep after you get in bed. Many people are around 10‚Äì20 minutes, but stress, caffeine, and screens can push it longer. If you often take 30+ minutes, try increasing the latency setting to make the recommendations more accurate."
            }
          },
          {
            "@type": "Question",
            "name": "Is it better to wake at the end of a sleep cycle?",
            "acceptedAnswer": {
              "@type": "Answer",
              "text": "Waking near the end of a cycle may reduce sleep inertia (that groggy feeling), because you're less likely to wake from deep sleep. It's not perfect‚Äîsleep stages aren't a stopwatch‚Äîbut cycle-based planning is a useful starting point."
            }
          },
          {
            "@type": "Question",
            "name": "What is a wake window?",
            "acceptedAnswer": {
              "@type": "Answer",
              "text": "A wake window is a small time range (like 10‚Äì15 minutes) around your target bedtime or wake time. It adds flexibility so you can aim for a window instead of a single exact minute, while keeping the overall cycle timing similar."
            }
          }
        ]
      }
    ]
  }
  </script>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">üåô</div><span class="brand-name">NightOwl</span>
      </div>
      <h1 class="title">Sleep Cycle Calculator</h1>
      <p class="subtitle">Bedtimes + wake windows based on 90-minute cycles</p>
    </header>

    <div class="ad-space">Advertisement Space</div>

    <div class="mode-tabs">
      <button class="mode-btn active" data-mode="wake">
        <span>‚è∞</span> Wake up at...
      </button>
      <button class="mode-btn" data-mode="sleep">
        <span>üõèÔ∏è</span> Bedtime now
      </button>
    </div>

    <div class="main-content">
      <div class="settings-toggle">
        <button class="settings-toggle-btn" id="toggleSettings">Settings</button>
      </div>

      <div class="settings-grid" id="settingsGrid">
        <div class="setting-group">
          <label class="setting-label">Sleep Latency</label>
          <input type="range" id="latency" min="0" max="60" value="10">
          <div class="setting-value"><span id="latencyValue">10</span> min</div>
        </div>
        <div class="setting-group">
          <label class="setting-label">Cycle Length</label>
          <input type="range" id="cycleLength" min="80" max="110" value="90">
          <div class="setting-value"><span id="cycleLengthValue">90</span> min</div>
        </div>
        <div class="setting-group">
          <label class="setting-label">Wake Window</label>
          <input type="range" id="wakeWindow" min="0" max="30" value="10">
          <div class="setting-value"><span id="wakeWindowValue">10</span> min</div>
        </div>
        <div class="setting-group">
          <label class="setting-label">Time Format</label>
          <div class="time-format-toggle">
            <div class="toggle-switch active" id="timeFormatToggle">
              <div class="toggle-option active" data-format="12">12h</div>
              <div class="toggle-option" data-format="24">24h</div>
            </div>
          </div>
        </div>
      </div>

      <label class="label" id="timeLabel">I want to wake up at...</label>

      <div class="time-picker-container">
        <div class="time-picker" id="timePicker">
          <div class="time-column" id="hourColumn">
            <div class="time-column-faded" id="hourAbove">12</div>
            <div class="time-column-selected" id="hourSelected">01</div>
            <div class="time-column-faded" id="hourBelow">02</div>
            <div class="time-column-highlight"></div>
          </div>
          
          <div class="time-column-separator">:</div>
          
          <div class="time-column" id="minuteColumn">
            <div class="time-column-faded" id="minuteAbove">59</div>
            <div class="time-column-selected" id="minuteSelected">00</div>
            <div class="time-column-faded" id="minuteBelow">01</div>
            <div class="time-column-highlight"></div>
          </div>
          
          <div class="time-column" id="periodColumn">
            <div class="time-column-faded" id="periodAbove">PM</div>
            <div class="time-column-selected" id="periodSelected">AM</div>
            <div class="time-column-faded" id="periodBelow">PM</div>
            <div class="time-column-highlight"></div>
          </div>

          <!-- Cute Owl Emoji -->
          <div class="owl-perch">ü¶â</div>
        </div>
      </div>

      <div class="results" id="results">
        <div class="results-label" id="resultsLabel">Go to bed at...</div>
        <div class="results-list" id="resultsList"></div>
      </div>

      <button class="info-toggle" id="infoToggle">
        <span class="info-title">How this sleep cycle calculator works</span>
        <span class="info-arrow">‚ñº</span>
      </button>
      <div class="info-section" id="infoSection" style="display: none;">
        <p>NightOwl Sleep Calc helps you choose bedtimes and wake-up times by counting full sleep cycles. A sleep cycle is the pattern your brain repeats through the night as you move through lighter sleep, deeper sleep, and REM. Many people average about a 90-minute cycle, which is why the calculator starts there‚Äîbut everyone is different, so you can adjust the cycle length if you know you run shorter or longer.</p>
        <p>The calculator also includes sleep latency, which is the time it typically takes you to fall asleep after you get into bed. If you usually drift off quickly, a lower latency may fit you better. If it often takes you longer‚Äîbecause of stress, caffeine, or screens‚Äîraise the latency setting so the recommendations match real life.</p>
        <p>To use the tool, pick either "Wake up at‚Ä¶" to find the best time to go to bed, or "Bedtime now" to see when you might wake up feeling more refreshed. Each option shows a wake window: a flexible range (like 10 minutes) around the suggested time. That window makes planning easier, because you can aim for a range instead of a single exact minute while still staying close to an end-of-cycle wake-up.</p>
      </div>

      <button class="info-toggle" id="infoToggle2">
        <span class="info-title">How many sleep cycles do I need?</span>
        <span class="info-arrow">‚ñº</span>
      </button>
      <div class="info-section" id="infoSection2" style="display: none;">
        <p>Many adults feel best with about 5‚Äì6 cycles, which is roughly 7.5‚Äì9 hours of sleep time (plus sleep latency). If you're catching up on sleep, 6‚Äì7 cycles may feel better; if you're short on time, 4 cycles can be a workable minimum.</p>
      </div>

      <button class="info-toggle" id="infoToggle3">
        <span class="info-title">Why 90 minutes?</span>
        <span class="info-arrow">‚ñº</span>
      </button>
      <div class="info-section" id="infoSection3" style="display: none;">
        <p>A full sleep cycle often averages around 90 minutes, but it can vary across people and across nights. That's why the cycle length setting is adjustable‚Äîuse the default as a starting point, then tweak it if the results consistently feel early or late for you.</p>
      </div>

      <button class="info-toggle" id="infoToggle4">
        <span class="info-title">What's a normal sleep latency?</span>
        <span class="info-arrow">‚ñº</span>
      </button>
      <div class="info-section" id="infoSection4" style="display: none;">
        <p>Sleep latency is how long it takes to fall asleep after you lie down. A common range is about 10‚Äì20 minutes, but it can be longer with stress, late caffeine, or bright screens. Set your latency to what's typical for you to keep the timing realistic.</p>
      </div>

      <button class="info-toggle" id="infoToggle5">
        <span class="info-title">Is it better to wake at the end of a cycle?</span>
        <span class="info-arrow">‚ñº</span>
      </button>
      <div class="info-section" id="infoSection5" style="display: none;">
        <p>Waking near the end of a cycle may reduce sleep inertia (the heavy, foggy feeling), since you're less likely to wake from deep sleep. Sleep isn't perfectly predictable, but cycle-based timing is a simple way to improve your odds.</p>
      </div>

      <button class="info-toggle" id="infoToggle6">
        <span class="info-title">What is a wake window?</span>
        <span class="info-arrow">‚ñº</span>
      </button>
      <div class="info-section" id="infoSection6" style="display: none;">
        <p>A wake window is a small range around a recommended bedtime or wake time, like 10‚Äì15 minutes. It gives you flexibility without changing the overall cycle timing much, so you can choose what fits your routine while staying close to the plan.</p>
      </div>

      <button class="share-btn" id="shareBtn" data-testid="button-share-link">Share Link</button>
    </div>
  </div>

  <footer>
    <div class="footer-copyright">NightOwl Sleep Calc. All rights reserved.</div>
    <div class="footer-disclaimer">Educational tool only ‚Äî not medical advice.</div>
  </footer>

  <script>
    const app = {
      mode: 'wake',
      hour: 1,
      minute: 0,
      period: 'AM',
      timeFormat: '12',
      settings: {
        latency: 10,
        cycleLength: 90,
        wakeWindow: 10
      },
      selectedResult: null,
      scrollVelocity: 0,
      lastWheelTime: 0,

      init() {
        this.setupEventListeners();
        this.loadSettings();
        this.loadFromUrl();
        this.calculate();
      },

      setupEventListeners() {
        // Info toggles - create event listeners for all expandable sections
        for (let i = 1; i <= 6; i++) {
          document.getElementById(`infoToggle${i === 1 ? '' : i}`).addEventListener('click', () => {
            const infoSection = document.getElementById(`infoSection${i === 1 ? '' : i}`);
            const infoToggle = document.getElementById(`infoToggle${i === 1 ? '' : i}`);
            const isExpanded = infoSection.style.display !== 'none';
            infoSection.style.display = isExpanded ? 'none' : 'block';
            infoToggle.classList.toggle('expanded');
          });
        }

        // Mode tabs
        document.querySelectorAll('.mode-btn').forEach(btn => {
          btn.addEventListener('click', (e) => this.setMode(e.target.closest('.mode-btn').dataset.mode));
        });

        // Share link button
        document.getElementById('shareBtn').addEventListener('click', () => this.shareLink());

        // Settings toggle
        document.getElementById('toggleSettings').addEventListener('click', () => {
          document.getElementById('settingsGrid').classList.toggle('show');
        });

        // Settings sliders
        document.getElementById('latency').addEventListener('input', (e) => {
          this.settings.latency = parseInt(e.target.value);
          document.getElementById('latencyValue').textContent = this.settings.latency;
          this.saveSettings();
          this.calculate();
        });

        document.getElementById('cycleLength').addEventListener('input', (e) => {
          this.settings.cycleLength = parseInt(e.target.value);
          document.getElementById('cycleLengthValue').textContent = this.settings.cycleLength;
          this.saveSettings();
          this.calculate();
        });

        document.getElementById('wakeWindow').addEventListener('input', (e) => {
          this.settings.wakeWindow = parseInt(e.target.value);
          document.getElementById('wakeWindowValue').textContent = this.settings.wakeWindow;
          this.saveSettings();
          this.calculate();
        });

        // Time format toggle
        document.querySelectorAll('.toggle-option').forEach(btn => {
          btn.addEventListener('click', (e) => this.setTimeFormat(e.target.dataset.format));
        });

        // Time picker scroll
        ['hourColumn', 'minuteColumn', 'periodColumn'].forEach(id => {
          const col = document.getElementById(id);
          col.addEventListener('wheel', (e) => this.handleTimeScroll(e, id));
          col.addEventListener('touchstart', (e) => this.handleTouchStart(e, id));
          col.addEventListener('touchmove', (e) => this.handleTouchMove(e, id));
        });

        document.getElementById('timePicker').addEventListener('wheel', (e) => {
          e.preventDefault();
          e.stopPropagation();
        });
      },

      setTimeFormat(format) {
        if (this.timeFormat === '12' && format === '24') {
          // Converting from 12h to 24h
          let hour24 = this.hour;
          if (this.period === 'PM' && this.hour !== 12) hour24 += 12;
          if (this.period === 'AM' && this.hour === 12) hour24 = 0;
          this.hour = hour24;
          this.period = 'AM'; // Clear period in 24h mode
        } else if (this.timeFormat === '24' && format === '12') {
          // Converting from 24h to 12h
          const period = this.hour >= 12 ? 'PM' : 'AM';
          const hour12 = this.hour % 12 || 12;
          this.hour = hour12;
          this.period = period;
        }
        
        this.timeFormat = format;
        document.querySelectorAll('.toggle-option').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.format === format);
        });
        document.getElementById('timeFormatToggle').classList.toggle('active', format === '24');
        this.updateTimePicker();
        this.calculate();
        this.saveSettings();
      },

      setMode(mode) {
        this.mode = mode;
        document.querySelectorAll('.mode-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.mode === mode);
        });

        if (mode === 'sleep') {
          const now = new Date();
          this.hour = now.getHours() % 12 || 12;
          this.minute = now.getMinutes();
          this.period = now.getHours() >= 12 ? 'PM' : 'AM';
          document.getElementById('timeLabel').textContent = "I'm going to bed now";
        } else {
          document.getElementById('timeLabel').textContent = 'I want to wake up at...';
        }

        this.updateTimePicker();
        this.calculate();
      },

      handleTimeScroll(e, columnId) {
        e.preventDefault();
        e.stopPropagation();

        if (columnId === 'periodColumn' && this.timeFormat === '12') {
          const direction = e.deltaY > 0 ? 1 : -1;
          this.period = direction > 0 ? 'PM' : 'AM';
          this.updateTimePicker();
          this.calculate();
        } else if (columnId === 'hourColumn') {
          const direction = e.deltaY > 0 ? 1 : -1;
          this.scrollVelocity += direction;

          if (Math.abs(this.scrollVelocity) >= 6) {
            if (this.timeFormat === '12') {
              this.hour = ((this.hour - 1 + (this.scrollVelocity > 0 ? 1 : -1) + 12) % 12) + 1;
            } else {
              this.hour = (this.hour + (this.scrollVelocity > 0 ? 1 : -1) + 24) % 24;
            }
            this.scrollVelocity = 0;
            this.updateTimePicker();
            this.calculate();
          }
        } else if (columnId === 'minuteColumn') {
          const direction = e.deltaY > 0 ? 1 : -1;
          this.scrollVelocity += direction;

          if (Math.abs(this.scrollVelocity) >= 6) {
            this.minute = (this.minute + (this.scrollVelocity > 0 ? 1 : -1) + 60) % 60;
            this.scrollVelocity = 0;
            this.updateTimePicker();
            this.calculate();
          }
        }
      },

      handleTouchStart(e, columnId) {
        e.currentTarget.touchStartY = e.touches[0].clientY;
      },

      handleTouchMove(e, columnId) {
        if (!e.currentTarget.touchStartY) return;
        const diff = e.touches[0].clientY - e.currentTarget.touchStartY;
        if (Math.abs(diff) > 20) {
          const direction = diff > 0 ? -1 : 1;
          if (columnId === 'periodColumn' && this.timeFormat === '12') {
            this.period = direction > 0 ? 'PM' : 'AM';
            e.currentTarget.touchStartY = e.touches[0].clientY;
            this.updateTimePicker();
            this.calculate();
          } else if (columnId === 'hourColumn') {
            if (this.timeFormat === '12') {
              this.hour = ((this.hour - 1 + direction + 12) % 12) + 1;
            } else {
              this.hour = (this.hour + direction + 24) % 24;
            }
            e.currentTarget.touchStartY = e.touches[0].clientY;
            this.updateTimePicker();
            this.calculate();
          } else if (columnId === 'minuteColumn') {
            this.minute = (this.minute + direction + 60) % 60;
            e.currentTarget.touchStartY = e.touches[0].clientY;
            this.updateTimePicker();
            this.calculate();
          }
        }
      },

      updateTimePicker() {
        if (this.timeFormat === '12') {
          document.getElementById('hourSelected').textContent = String(this.hour).padStart(2, '0');
          document.getElementById('hourAbove').textContent = String(((this.hour - 2 + 12) % 12) + 1).padStart(2, '0');
          document.getElementById('hourBelow').textContent = String((this.hour % 12) + 1).padStart(2, '0');
          document.getElementById('periodSelected').textContent = this.period;
          document.getElementById('periodAbove').textContent = this.period === 'AM' ? 'PM' : 'AM';
          document.getElementById('periodBelow').textContent = this.period === 'AM' ? 'PM' : 'AM';
          document.getElementById('periodColumn').style.display = 'flex';
        } else {
          const hour24 = this.period === 'AM' ? this.hour === 12 ? 0 : this.hour : this.hour === 12 ? 12 : this.hour + 12;
          document.getElementById('hourSelected').textContent = String(hour24).padStart(2, '0');
          document.getElementById('hourAbove').textContent = String((hour24 - 1 + 24) % 24).padStart(2, '0');
          document.getElementById('hourBelow').textContent = String((hour24 + 1) % 24).padStart(2, '0');
          document.getElementById('periodColumn').style.display = 'none';
        }

        document.getElementById('minuteSelected').textContent = String(this.minute).padStart(2, '0');
        document.getElementById('minuteAbove').textContent = String((this.minute - 1 + 60) % 60).padStart(2, '0');
        document.getElementById('minuteBelow').textContent = String((this.minute + 1) % 60).padStart(2, '0');
      },


      to24Hour(hour, minute, period) {
        let h = hour;
        if (period === 'PM' && hour !== 12) h += 12;
        if (period === 'AM' && hour === 12) h = 0;
        return h * 60 + minute;
      },

      formatTime(totalMinutes) {
        totalMinutes = totalMinutes % (24 * 60);
        if (totalMinutes < 0) totalMinutes += 24 * 60;
        const h = Math.floor(totalMinutes / 60);
        const m = totalMinutes % 60;
        if (this.timeFormat === '12') {
          const period = h >= 12 ? 'PM' : 'AM';
          const hour12 = h % 12 || 12;
          return `${String(hour12).padStart(2, '0')}:${String(m).padStart(2, '0')} ${period}`;
        } else {
          return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        }
      },

      calculate() {
        const startTime = this.to24Hour(this.hour, this.minute, this.period);
        const results = [];

        if (this.mode === 'wake') {
          // Mode A: "Wake up at..." - generate bedtime recommendations
          for (let cycles = 4; cycles <= 6; cycles++) {
            const sleepDuration = this.settings.latency + cycles * this.settings.cycleLength;
            let bedTime = startTime - sleepDuration;
            if (bedTime < 0) bedTime += 24 * 60;

            // Bedtime window: bedTime to bedTime + wakeWindow
            const bedWindowEnd = (bedTime + this.settings.wakeWindow) % (24 * 60);

            results.push({
              cycles: cycles,
              bedTime: bedTime,
              bedTimeStr: this.formatTime(bedTime),
              wakeTime: startTime,
              wakeWindowStr: `${this.formatTime(bedTime)} - ${this.formatTime(bedWindowEnd)}`,
              duration: `${(sleepDuration / 60).toFixed(1)} hrs`
            });
          }
        } else {
          // Mode B: "Bedtime now" - generate wake-up recommendations
          const bedTime = startTime;
          for (let cycles = 4; cycles <= 6; cycles++) {
            const sleepDuration = this.settings.latency + cycles * this.settings.cycleLength;
            const wakeTime = bedTime + sleepDuration;

            // Wake window: wakeTime to wakeTime + wakeWindow
            const wakeWindowEnd = (wakeTime + this.settings.wakeWindow) % (24 * 60);

            results[cycles - 4] = {
              cycles: cycles,
              wakeTime: wakeTime % (24 * 60),
              wakeTimeStr: this.formatTime(wakeTime),
              bedTime: bedTime,
              wakeWindowStr: `${this.formatTime(wakeTime)} - ${this.formatTime(wakeWindowEnd)}`,
              duration: `${(sleepDuration / 60).toFixed(1)} hrs`
            };
          }
        }

        this.renderResults(results);
      },

      renderResults(results) {
        const listHtml = results.map((r, i) => {
          const isBest = Math.abs(r.cycles - 5) === 0;
          const resultTime = this.mode === 'wake' ? r.bedTimeStr : r.wakeTimeStr;
          const isSelected = this.selectedResult === i;
          const windowLabel = this.mode === 'wake' ? 'Go to bed between:' : 'Wake between:';
          const showWindow = this.settings.wakeWindow > 0;

          return `
            <button class="result-card ${isSelected ? 'selected' : ''} ${isBest ? 'best' : ''}" data-index="${i}">
              <div class="result-time">${resultTime}</div>
              ${showWindow ? `<div class="result-window">${windowLabel} ${r.wakeWindowStr}</div>` : ''}
              <div class="result-details">
                <span class="result-detail">${r.cycles} cycles</span>
                <span class="result-detail">${r.duration}</span>
              </div>
            </button>
          `;
        }).join('');

        document.getElementById('resultsList').innerHTML = listHtml;

        document.querySelectorAll('.result-card').forEach(card => {
          card.addEventListener('click', () => {
            const index = card.dataset.index;
            document.querySelectorAll('.result-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            this.selectedResult = index;
          });
        });

        document.getElementById('resultsLabel').textContent = this.mode === 'wake' ? 'Go to bed at...' : 'Wake up at...';
      },

      saveSettings() {
        localStorage.setItem('sleepSettings', JSON.stringify(this.settings));
      },

      loadFromUrl() {
        const params = new URLSearchParams(window.location.search);
        if (params.has('mode')) {
          const mode = params.get('mode');
          if (mode === 'wake' || mode === 'sleep') this.setMode(mode);
        }
        if (params.has('hour')) this.hour = Math.max(1, Math.min(12, parseInt(params.get('hour')) || 1));
        if (params.has('minute')) this.minute = Math.max(0, Math.min(59, parseInt(params.get('minute')) || 0));
        if (params.has('period')) {
          const period = params.get('period');
          if (period === 'AM' || period === 'PM') this.period = period;
        }
        if (params.has('latency')) this.settings.latency = Math.max(0, Math.min(60, parseInt(params.get('latency')) || 10));
        if (params.has('cycleLength')) this.settings.cycleLength = Math.max(80, Math.min(110, parseInt(params.get('cycleLength')) || 90));
        this.updateTimePicker();
      },

      shareLink() {
        const params = new URLSearchParams({
          mode: this.mode,
          hour: this.hour,
          minute: this.minute,
          period: this.period,
          latency: this.settings.latency,
          cycleLength: this.settings.cycleLength
        });
        const shareUrl = `${window.location.origin}${window.location.pathname}?${params.toString()}`;
        navigator.clipboard.writeText(shareUrl).then(() => {
          const btn = document.getElementById('shareBtn');
          const originalText = btn.textContent;
          btn.textContent = 'Link copied!';
          setTimeout(() => { btn.textContent = originalText; }, 2000);
        }).catch(() => { alert('Could not copy link. URL: ' + shareUrl); });
      },

      loadSettings() {
        const saved = localStorage.getItem('sleepSettings');
        if (saved) {
          const data = JSON.parse(saved);
          this.settings = data.settings || this.settings;
          this.timeFormat = data.timeFormat || '12';
          document.getElementById('latencyValue').textContent = this.settings.latency;
          document.getElementById('cycleLengthValue').textContent = this.settings.cycleLength;
          document.getElementById('wakeWindowValue').textContent = this.settings.wakeWindow;
          document.getElementById('latency').value = this.settings.latency;
          document.getElementById('cycleLength').value = this.settings.cycleLength;
          document.getElementById('wakeWindow').value = this.settings.wakeWindow;
          document.querySelectorAll('.toggle-option').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.format === this.timeFormat);
          });
          document.getElementById('timeFormatToggle').classList.toggle('active', this.timeFormat === '24');
        }
      },

      saveSettings() {
        localStorage.setItem('sleepSettings', JSON.stringify({ settings: this.settings, timeFormat: this.timeFormat }));
      }
    };

    app.init();
  </script>
</body>
</html>
